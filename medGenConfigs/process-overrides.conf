// Raredisease pipeline Process-specifc argument overrides are set in the workflow
// directory, under raredisease. 

// This is custom (Oslo MedGen) argument overrides such as resource allocations and some hacks.


process {

    withName:"BWAMEM2_INDEX_GENOME" {
    	memory = 70.GB
    }
    withName:"BWAMEM2_MEM" {
    	cpus = 64
    	memory = 128.GB
        time = 1.d
    }
    withName:"MARKDUPLICATES" {
        time = 1.d
    }
    withName: "QUALIMAP_BAMQC" {
        // Qualimap needs more than 32 GB. For large files it doesnt work with
        // 64 GB either. It also may need a bit more time than the default 8h.
        memory = 96.GB
        time = 16.h
    }
    withName:"DEEPVARIANT" {
    	cpus = 64
    	memory = 60.GB
        time = 2.d
    }
    withName:".*PICARD_COLLECTHSMETRICS" {
        ext.when = false
    }
    withName:"PICARD_COLLECTWGSMETRICS" {
        time = 16.h
    }
    withName:"CADD" {
        container = "$baseDir/../../singularity/local-cadd-v1.6.sif"
        containerOptions = "-B $launchDir/ref/CADD-v1.6:/opt/conda/envs/cadd/share/cadd-scripts-1.6-1/data/annotations"
    }
    withName:"GENMOD_MODELS" {
    	memory = 96.GB
    }
    withName:"TIDDIT_SV" {
        // SV calling can exceed 8 hrs on slow CPUs and big datasets.
        time = 16.h
    }

    // Set VCF file names for VEP. Original args block copied from:
    // https://github.com/nf-core/raredisease/blob/dev/conf/modules/annotate_snvs.config
    // Then, only the SpliceAI file names were changed.
    withName: '.*ANNOTATE_SNVS:ENSEMBLVEP_SNV' {
        ext.args   = [
            '--dir_plugins vep_cache/Plugins',
            '--plugin LoFtool,vep_cache/LoFtool_scores.txt',
            '--plugin pLI,vep_cache/pLI_values_107.txt',
            '--plugin SpliceAI,snv=vep_cache/spliceai_scores.raw.snv.hg38.vcf.gz,indel=vep_cache/spliceai_scores.raw.indel.hg38.vcf.gz',
            '--plugin MaxEntScan,vep_cache/fordownload,SWA,NCSS',
            '--distance 5000',
            '--buffer_size 20000',
            '--format vcf --max_sv_size 248956422',
            '--appris --biotype --cache --canonical --ccds --compress_output bgzip',
            '--domains --exclude_predicted --force_overwrite',
            '--hgvs --humdiv --no_progress --no_stats --numbers',
            '--merged --polyphen p --protein --offline --regulatory --sift p --symbol --tsl',
            '--uniprot --vcf'
        ].join(' ')
    }

    // The output of SV ranking is not valid for tabix, so we skip this step.
    // The SV ranking is probably not usable since the output is not sorted,
    // so for now we disable all ranking processes.
    withName: '.*RANK_VARIANTS_SV:.*' {
        ext.when = false
    }

    // Disable genmod variant ranking due to problems with MT-dna variant annotations.
    // The problem occurs in GENMOD_SCORE.
    // https://github.com/nf-core/raredisease/issues/370
    withName: '.*RANK_VARIANTS_SNV:GENMOD_MODELS' {
        ext.when = false
    }
    withName: '.*RANK_VARIANTS_SNV:GENMOD_SCORE' {
        ext.when = false
    }
    withName: '.*RANK_VARIANTS_SNV:GENMOD_COMPOUND' {
        ext.when = false
    }
    withName: '.*RANK_VARIANTS_SNV:TABIX_BGZIPTABIX' {
        ext.when = false
    }
}

report {
    enabled = true
    overwrite = true
    file = "$params.outdir/pipeline_info/nextflow_report.html"
}

